# Reports Section - Implementation Summary

## Overview
The Reports section has been successfully implemented in the AccountTrack system, allowing both **Managers** and **Admins** to generate, view, and manage reports for transactions, accounts, and compliance metrics.

---

## Access Control

### Role-Based Permissions

| Action | Endpoint | Admin | Manager | Officer |
|--------|----------|-------|---------|---------|
| **View All Reports** | `GET /api/reports` | ‚úÖ | ‚úÖ | ‚ùå |
| **View Filtered Reports** | `GET /api/reports/filtered` | ‚úÖ | ‚úÖ | ‚ùå |
| **View Report by ID** | `GET /api/reports/{id}` | ‚úÖ | ‚úÖ | ‚ùå |
| **View My Reports** | `GET /api/reports/my-reports` | ‚úÖ | ‚úÖ | ‚ùå |
| **Generate Report** | `POST /api/reports/generate` | ‚úÖ | ‚úÖ | ‚ùå |
| **Delete Report** | `DELETE /api/reports/{id}` | ‚úÖ | ‚úÖ | ‚ùå |

---

## Database Schema

### Reports Table Structure

| Column | Type | Description |
|--------|------|-------------|
| `Id` | int | Primary key (Identity) |
| `AccountId` | int (nullable) | Foreign key to Accounts table |
| `DataJson` | nvarchar(max) | JSON data with additional metrics |
| `FilePath` | nvarchar(500) | File path if report is exported |
| `FromDate` | datetime2 (nullable) | Report period start date |
| `GeneratedAt` | datetime2 | Timestamp when generated (default: GETDATE()) |
| `GeneratedByUserId` | nvarchar(50) | User ID who generated the report |
| `GrowthRate` | decimal(18,2) | Account growth rate percentage (default: 0.00) |
| `ReportType` | nvarchar(50) | Type: transaction, compliance, growth, etc. |
| `Title` | nvarchar(200) | Report title/name |
| `ToDate` | datetime2 (nullable) | Report period end date |
| `TotalAmount` | decimal(18,2) | Total transaction amount (default: 0.00) |
| `TotalTransactions` | int | Total number of transactions (default: 0) |
| `TransactionStatus` | nvarchar(50) | Filter: done, pending, etc. |
| `TransactionType` | nvarchar(50) | Filter: withdraw, deposit, transfer |

### Indexes
- `IX_Reports_AccountId` - On AccountId
- `IX_Reports_GeneratedAt` - On GeneratedAt
- `IX_Reports_GeneratedByUserId` - On GeneratedByUserId
- `IX_Reports_ReportType` - On ReportType
- `IX_Reports_FromDate_ToDate` - Composite on FromDate, ToDate

### Foreign Keys
- **AccountId** ‚Üí Accounts.AccountId (ON DELETE SET NULL)

---

## API Endpoints

### 1. Get All Reports
**Endpoint:** `GET /api/reports`  
**Authorization:** Admin, Manager  
**Description:** Retrieves all reports in the system  

**Response Example:**
```json
[
  {
    "id": 1,
    "accountId": 1,
    "reportType": "transaction",
    "title": "Monthly Transaction Report",
    "totalTransactions": 150,
    "totalAmount": 25000.00,
    "growthRate": 12.5,
    "generatedAt": "2026-02-18T04:45:00",
    "generatedByUserId": "admin",
    "fromDate": "2026-01-01T00:00:00",
    "toDate": "2026-01-31T23:59:59"
  }
]
```

---

### 2. Get Filtered Reports (Paginated)
**Endpoint:** `GET /api/reports/filtered`  
**Authorization:** Admin, Manager  
**Query Parameters:**
- `reportType` (optional) - Filter by report type
- `accountId` (optional) - Filter by account ID
- `fromDate` (optional) - Filter by generation date start
- `toDate` (optional) - Filter by generation date end
- `pageNumber` (default: 1) - Page number
- `pageSize` (default: 10) - Items per page

**Example Request:**
```http
GET /api/reports/filtered?reportType=transaction&pageNumber=1&pageSize=10
```

**Response Example:**
```json
{
  "items": [
    {
      "id": 1,
      "reportType": "transaction",
      "title": "Weekly Report",
      ...
    }
  ],
  "totalCount": 25,
  "pageNumber": 1,
  "pageSize": 10,
  "totalPages": 3
}
```

---

### 3. Get Report by ID
**Endpoint:** `GET /api/reports/{id}`  
**Authorization:** Admin, Manager  
**Path Parameter:** `id` - Report ID

**Response Example:**
```json
{
  "id": 1,
  "accountId": 1,
  "reportType": "transaction",
  "title": "Monthly Transaction Report",
  "totalTransactions": 150,
  "totalAmount": 25000.00,
  "growthRate": 12.5,
  "generatedAt": "2026-02-18T04:45:00",
  "generatedByUserId": "admin",
  "fromDate": "2026-01-01T00:00:00",
  "toDate": "2026-01-31T23:59:59",
  "transactionStatus": "done",
  "transactionType": "withdraw",
  "dataJson": "{\"AverageTransactionAmount\":166.67,\"HighValueCount\":5,\"UniqueAccounts\":10}"
}
```

---

### 4. Get My Reports
**Endpoint:** `GET /api/reports/my-reports`  
**Authorization:** Admin, Manager  
**Description:** Returns reports generated by the currently authenticated user

**Response:** Array of ReportDto objects

---

### 5. Generate Report
**Endpoint:** `POST /api/reports/generate`  
**Authorization:** Admin, Manager  
**Content-Type:** application/json

**Request Body:**
```json
{
  "reportType": "transaction",
  "title": "Monthly Transaction Report - February 2026",
  "accountId": 1,
  "fromDate": "2026-02-01T00:00:00",
  "toDate": "2026-02-28T23:59:59",
  "transactionStatus": "done",
  "transactionType": "withdraw"
}
```

**Request Fields:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `reportType` | string | ‚úÖ Yes | Type of report (max 50 chars) |
| `title` | string | ‚úÖ Yes | Report title (max 200 chars) |
| `accountId` | int | ‚ùå No | Filter by specific account |
| `fromDate` | datetime | ‚ùå No | Period start date |
| `toDate` | datetime | ‚ùå No | Period end date |
| `transactionStatus` | string | ‚ùå No | Filter by status |
| `transactionType` | string | ‚ùå No | Filter by type |

**Response:** ReportDto with calculated metrics (201 Created)

---

### 6. Delete Report
**Endpoint:** `DELETE /api/reports/{id}`  
**Authorization:** Admin, Manager  
**Path Parameter:** `id` - Report ID

**Response:**
```json
{
  "message": "Report deleted successfully"
}
```

---

## Automatic Metrics Calculation

When a report is generated, the system automatically calculates:

### 1. **Total Transactions**
Count of all transactions matching the filter criteria

### 2. **Total Amount**
Sum of all transaction amounts in the period

### 3. **Growth Rate**
```
Growth Rate = (Active Accounts / Total Accounts) √ó 100
```

### 4. **Additional Metrics (stored in DataJson)**
- **AverageTransactionAmount**: Total Amount √∑ Total Transactions
- **HighValueCount**: Count of transactions with Flag ‚â† "Normal"
- **UniqueAccounts**: Count of distinct account IDs in transactions

---

## Implementation Architecture

### Files Created/Modified

#### **Models**
- ‚úÖ `Models/Report.cs` - Complete Report entity with 15 properties

#### **DTOs**
- ‚úÖ `DTOs/ReportDto.cs` - Report data transfer object
- ‚úÖ `DTOs/CreateReportDto.cs` - DTO for report generation
- ‚úÖ `DTOs/ReportFilterDto.cs` - DTO for filtering and pagination

#### **Repositories**
- ‚úÖ `Repositories/IReportRepository.cs` - Repository interface
- ‚úÖ `Repositories/ReportRepository.cs` - Repository implementation with:
  - GetByIdAsync
  - GetAllAsync
  - GetFilteredAsync (with pagination)
  - GetByUserAsync
  - CreateAsync
  - DeleteAsync
  - GetTotalCountAsync

#### **Services**
- ‚úÖ `Services/IReportService.cs` - Service interface
- ‚úÖ `Services/ReportService.cs` - Business logic with:
  - Metrics calculation
  - Report generation
  - CRUD operations
  - Data aggregation

#### **Controllers**
- ‚úÖ `Controllers/ReportsController.cs` - REST API with 6 endpoints

#### **Database**
- ‚úÖ `Data/AppDbContext.cs` - Report entity configuration
- ‚úÖ `Migrations/20260218044919_reports.cs` - Database migration

#### **Dependency Injection**
- ‚úÖ `Program.cs` - Registered IReportRepository and IReportService

---

## Usage Examples

### Example 1: Generate Monthly Transaction Report
```bash
curl -X POST "https://localhost:5001/api/reports/generate" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "reportType": "transaction",
    "title": "February 2026 All Withdrawals",
    "fromDate": "2026-02-01T00:00:00",
    "toDate": "2026-02-28T23:59:59",
    "transactionType": "withdraw"
  }'
```

### Example 2: Get Reports for Specific Account
```bash
curl -X GET "https://localhost:5001/api/reports/filtered?accountId=1&pageNumber=1&pageSize=5" \
  -H "Authorization: Bearer {token}"
```

### Example 3: View My Generated Reports
```bash
curl -X GET "https://localhost:5001/api/reports/my-reports" \
  -H "Authorization: Bearer {token}"
```

### Example 4: Delete a Report
```bash
curl -X DELETE "https://localhost:5001/api/reports/5" \
  -H "Authorization: Bearer {token}"
```

---

## Testing with Swagger

1. Navigate to `/swagger` in your browser
2. Click **Authorize** button
3. Enter: `Bearer {your-jwt-token}`
4. Navigate to **Reports** section
5. Test all 6 endpoints

---

## Report Types Supported

The system supports various report types (configurable):

- **transaction** - Transaction analysis reports
- **compliance** - Compliance and regulatory reports
- **growth** - Account growth and performance reports
- **account** - Account-specific reports
- **branch** - Branch-level reports
- **custom** - Custom report types

---

## Best Practices

### 1. **Report Naming Convention**
```
{ReportType} - {Period} - {Description}
Example: "Transaction - February 2026 - High Value Withdrawals"
```

### 2. **Date Ranges**
- Use UTC dates for consistency
- Set ToDate to end of day: `23:59:59`

### 3. **Pagination**
- Default page size: 10
- Recommended max page size: 100

### 4. **Report Retention**
- Consider implementing automatic report cleanup
- Archive old reports after 90 days
- Keep compliance reports for 7 years

---

## Security Features

‚úÖ **Role-Based Access Control** - Only Admin and Manager can access  
‚úÖ **JWT Authentication** - All endpoints require valid token  
‚úÖ **User Tracking** - Each report stores who generated it  
‚úÖ **Audit Trail** - GeneratedAt timestamp for all reports  
‚úÖ **Data Isolation** - Users can view their own reports via `/my-reports`

---

## Performance Optimizations

‚úÖ **Database Indexes** - 5 indexes on frequently queried columns  
‚úÖ **AsNoTracking** - Read-only queries for better performance  
‚úÖ **Pagination** - Prevents large result sets  
‚úÖ **Foreign Key Constraints** - Ensures data integrity  
‚úÖ **Default Values** - Reduces null checks and improves consistency

---

## Future Enhancements

### Potential Features:
1. **Export Reports** - PDF, Excel, CSV generation
2. **Scheduled Reports** - Automatic generation at intervals
3. **Email Delivery** - Send reports via email
4. **Report Templates** - Predefined report configurations
5. **Chart Data** - Visual representation of metrics
6. **Branch Filtering** - Filter reports by branch
7. **Report Sharing** - Share reports between users
8. **Report Comments** - Add notes/comments to reports

---

## Troubleshooting

### Issue: "User ID not found in token"
**Solution:** Ensure JWT token includes `UserId` claim

### Issue: Reports not appearing
**Solution:** Check role authorization - only Admin and Manager can access

### Issue: Foreign key constraint error
**Solution:** Ensure AccountId exists in Accounts table if provided

### Issue: Empty report data
**Solution:** Verify date ranges and ensure transactions exist in the period

---

## Migration Status

‚úÖ **Migration Created:** `20260218044919_reports.cs`  
‚úÖ **Migration Applied:** Run `dotnet ef database update`  
‚úÖ **Table Created:** Reports table with all columns and indexes  
‚úÖ **Build Status:** Successful  

---

## Summary

The Reports section is fully implemented with:
- ‚úÖ Complete database schema with 15 columns
- ‚úÖ 6 RESTful API endpoints
- ‚úÖ Role-based access for Admin and Manager
- ‚úÖ Automatic metrics calculation
- ‚úÖ Pagination and filtering support
- ‚úÖ Repository and service patterns
- ‚úÖ Comprehensive documentation

**Both Managers and Admins** have full access to view, generate, and delete reports! üéâ
