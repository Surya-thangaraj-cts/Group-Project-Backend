# JWT Claim Name Fix - "User ID not found in token"

## ğŸ”´ Error
```json
{
  "message": "User ID not found in token"
}
```

---

## âœ… Root Cause

**Mismatch between JWT claim name and controller code:**

### JWT Token Contains:
```csharp
// In JwtService.cs
new Claim("nameid", user.UserId)  // â† Actual claim name
```

### Controller Was Looking For:
```csharp
// In ReportsController.cs (OLD - WRONG)
var userId = User.FindFirstValue("UserId");  // âŒ Doesn't exist!
```

---

## âœ… Solution Applied

Updated `Controllers/ReportsController.cs` to use the correct claim name:

```csharp
// âœ… FIXED
var userId = User.FindFirstValue("nameid");  // Now matches JWT token
```

### Affected Methods:
1. âœ… `GetMyReports()` - Line 64
2. âœ… `GenerateReport()` - Line 81

---

## ğŸ” JWT Token Structure

Your JWT contains these claims:

| Claim Name | Value | Purpose |
|------------|-------|---------|
| `sub` | user.UserId | Subject (standard JWT claim) |
| `nameid` | user.UserId | User ID (custom claim) âœ… |
| `name` | user.Name | Display name |
| `email` | user.Email | User email |
| `role` | user.Role | Authorization role |
| `status` | user.Status | Account status |
| `jti` | GUID | Token ID |
| `iat` | timestamp | Issued at |

---

## ğŸ“‹ How to Get JWT Claims

### Option 1: Using Standard Claim Names
```csharp
var userId = User.FindFirstValue("nameid");
var userName = User.FindFirstValue("name");
var email = User.FindFirstValue(ClaimTypes.Email);
var role = User.FindFirstValue("role");
```

### Option 2: Using ClaimsPrincipal Extension
```csharp
var userId = User.FindFirstValue(ClaimTypes.NameIdentifier); // Gets "nameid"
var userName = User.Identity?.Name;
```

### Option 3: Loop Through All Claims (Debugging)
```csharp
foreach (var claim in User.Claims)
{
    Console.WriteLine($"{claim.Type}: {claim.Value}");
}
```

---

## ğŸ§ª Testing the Fix

### Test 1: Get My Reports
```bash
curl -X GET "https://localhost:5001/api/reports/my-reports" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**Expected:** List of reports generated by the authenticated user

---

### Test 2: Generate Report
```bash
curl -X POST "https://localhost:5001/api/reports/generate" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "reportType": "transaction",
    "title": "Test Report",
    "fromDate": "2026-01-01T00:00:00",
    "toDate": "2026-01-31T23:59:59"
  }'
```

**Expected:** New report created with `generatedByUserId` set to the authenticated user's ID

---

## ğŸ” Debugging JWT Claims

### Method 1: Add Logging
```csharp
[HttpGet("my-reports")]
public async Task<IActionResult> GetMyReports(CancellationToken ct)
{
    // Log all claims for debugging
    var claims = User.Claims.Select(c => $"{c.Type}={c.Value}");
    Console.WriteLine($"Claims: {string.Join(", ", claims)}");
    
    var userId = User.FindFirstValue("nameid");
    if (string.IsNullOrEmpty(userId))
        return Unauthorized(new { message = "User ID not found in token" });

    var reports = await _reportService.GetReportsByUserAsync(userId, ct);
    return Ok(reports);
}
```

### Method 2: Return Claims in Response (Development Only)
```csharp
[HttpGet("debug/claims")]
[Authorize]
public IActionResult GetClaims()
{
    var claims = User.Claims.Select(c => new { c.Type, c.Value });
    return Ok(claims);
}
```

---

## ğŸ“ Consistency Across Controllers

Ensure all controllers use the same claim name:

### âœ… Correct Pattern:
```csharp
var userId = User.FindFirstValue("nameid");
```

### Check These Controllers:
- âœ… `ReportsController.cs` - FIXED
- â“ `TransactionsController.cs` - Verify
- â“ `ApprovalsController.cs` - Verify
- â“ `NotificationsController.cs` - Verify
- â“ `AccountsController.cs` - Verify

---

## ğŸ¯ Alternative Solution (Optional)

If you prefer using "UserId" as the claim name, update `JwtService.cs`:

```csharp
// In JwtService.cs
var claims = new List<Claim>
{
    new Claim(JwtRegisteredClaimNames.Sub, user.UserId),
    new Claim("UserId", user.UserId),  // â† Add this
    new Claim("nameid", user.UserId),  // Keep for backward compatibility
    new Claim("name", user.Name ?? string.Empty),
    // ... rest of claims
};
```

Then you can use either:
```csharp
var userId = User.FindFirstValue("UserId");  // New name
// OR
var userId = User.FindFirstValue("nameid");  // Original name
```

---

## âœ… Fix Verified

- âœ… Build successful
- âœ… Claim name changed from "UserId" to "nameid"
- âœ… Both methods updated (GetMyReports, GenerateReport)
- âœ… Matches JWT token structure

---

## ğŸš€ Next Steps

1. **Restart your application** (stop debugger and restart)
2. **Test the endpoints** with a valid JWT token
3. **Verify other controllers** use the same claim name
4. **Consider adding claim logging** for easier debugging

---

**Issue Resolved! The controller now correctly reads the user ID from the JWT token.** âœ…
